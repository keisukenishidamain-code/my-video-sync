<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ï¼ˆå†ç”Ÿçª“ãªã—ï¼‰</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --main-red: #ff4444; --bg-dark: #121212; --panel-bg: #1e1e1e; }
        body { font-family: sans-serif; background: var(--bg-dark); color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .panel { width: 100%; max-width: 600px; background: var(--panel-bg); padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { border-left: 4px solid var(--main-red); padding-left: 15px; margin-bottom: 25px; }
        
        .status-box { background: #000; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .status-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        #current-title { font-weight: bold; color: var(--main-red); }

        .input-group { margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: white; box-sizing: border-box; margin-bottom: 10px; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-ready { background: #444; color: white; }
        .btn-start { background: var(--main-red); color: white; grid-column: span 2; font-size: 18px; }
        .btn-stop { background: #555; color: white; }
        button:hover { opacity: 0.8; transform: scale(0.98); }
        
        #log { margin-top: 20px; font-size: 12px; color: #666; text-align: center; }
    </style>
</head>
<body>

<div class="panel">
    <h2>é…ä¿¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>

    <div class="status-box">
        <div class="status-label">ç¾åœ¨æ”¾é€ä¸­ï¼ˆé¡§å®¢å´ã®ç”»é¢ï¼‰</div>
        <div id="current-title">åœæ­¢ä¸­</div>
        <div id="current-time" style="font-family: monospace; font-size: 20px; margin-top:10px;">00:00</div>
    </div>

    <div class="input-group">
        <div class="status-label">æ¬¡ã®æ›²ã‚’æº–å‚™ï¼ˆYouTube URLï¼‰</div>
        <input type="text" id="nextUrl" placeholder="https://www.youtube.com/watch?v=...">
        <div id="next-preview" style="font-size: 12px; color: #0f0; margin-top: -5px; margin-bottom: 10px; display: none;">âœ“ æ¬¡ã®æ›²ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ</div>
    </div>

    <div class="btn-grid">
        <button class="btn-start" onclick="startNextTrack()">ğŸš€ æ¬¡ã®æ›²ã‚’é–‹å§‹ï¼ˆï¼†ä¿å­˜ï¼‰</button>
        <button class="btn-stop" onclick="togglePause()">ä¸€æ™‚åœæ­¢ / å†é–‹</button>
        <button class="btn-stop" onclick="stopVideo()">å®Œå…¨åœæ­¢ï¼ˆãƒ­ã‚´ã¸ï¼‰</button>
    </div>

    <div id="log">ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­</div>
</div>

<script>
    // FirebaseåˆæœŸåŒ–ï¼ˆã‚ãªãŸã®è¨­å®šï¼‰
    const firebaseConfig = {
        apiKey: "AIzaSyDoZtzHkOcC3p565fLN4oGO7vmlwQZiNkE",
        databaseURL: "https://club-d0011-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "club-d0011",
        appId: "1:51948793811:web:1edecab7c41c1d84ad8926"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let playStartTime = 0;
    let timerInterval = null;
    let isPaused = false;
    let currentVideoId = "";

    // YouTube IDã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
    function getID(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : url;
    }

    // æ¬¡ã®æ›²ã‚’é–‹å§‹
    function startNextTrack() {
        const url = document.getElementById('nextUrl').value;
        const id = getID(url);
        
        if (!id) {
            alert("æœ‰åŠ¹ãªYouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        currentVideoId = id;
        playStartTime = Date.now();
        isPaused = false;

        // Firebaseæ›´æ–°ï¼ˆç¾åœ¨ã®å†ç”Ÿï¼‰
        db.ref('sync').set({
            videoId: id,
            state: 1,
            serverStartTime: firebase.database.ServerValue.TIMESTAMP,
            baseTime: 0
        });

        // è‡ªå‹•ä¿å­˜ï¼ˆãƒãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ï¼‰
        const now = new Date();
        db.ref('backnumbers').push({
            title: `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')} é…ä¿¡é–‹å§‹`,
            videoId: id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        // UIæ›´æ–°
        document.getElementById('current-title').innerText = "å‹•ç”»ID: " + id;
        document.getElementById('nextUrl').value = "";
        document.getElementById('log').innerText = "æ–°ã—ã„æ›²ã‚’é–‹å§‹ã—ã¾ã—ãŸ";
        
        startTimer();
    }

    // åœæ­¢ï¼ˆãƒ­ã‚´ç”»é¢ã«æˆ»ã™ï¼‰
    function stopVideo() {
        db.ref('sync').update({ state: 0 });
        clearInterval(timerInterval);
        document.getElementById('current-title').innerText = "åœæ­¢ä¸­";
        document.getElementById('current-time').innerText = "00:00";
    }

    // ä¸€æ™‚åœæ­¢ãƒ»å†é–‹ï¼ˆç°¡æ˜“çš„ãªã‚‚ã®ï¼‰
    function togglePause() {
        isPaused = !isPaused;
        db.ref('sync').update({ state: isPaused ? 2 : 1 });
        document.getElementById('log').innerText = isPaused ? "ä¸€æ™‚åœæ­¢ä¸­" : "å†é–‹ã—ã¾ã—ãŸ";
    }

    // æ‰‹å…ƒã®çµŒéæ™‚é–“ã‚¿ã‚¤ãƒãƒ¼
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (isPaused) return;
            const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            document.getElementById('current-time').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }, 1000);
    }
</script>
</body>
</html>
