<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>27 Club - Staff Cockpit (Queue-Focused)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --main-red: #ff0033; --neon: 0 0 10px #ff0033; --border-color: #444; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100vh; background: #000; color: #fff; font-family: 'Orbitron', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .master-container { display: flex; width: 100%; max-width: 1100px; height: 95vh; background: #0a0a0a; border: 1px solid var(--border-color); box-sizing: border-box; }
        .left { width: 42%; padding: 15px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .right { width: 58%; padding: 15px; background: #050505; display: flex; flex-direction: column; }
        .logo { font-size: 18px; font-weight: 900; letter-spacing: 3px; margin-bottom: 10px; }
        .logo span { color: var(--main-red); text-shadow: var(--neon); }
        .section-label { font-size: 9px; color: #fff; letter-spacing: 1px; margin: 5px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 3px; text-transform: uppercase; }
        .input-group { background: #111; padding: 10px; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        input[type="text"] { width: 100%; padding: 10px; background: #000; border: 1px solid #555; color: #fff; font-family: 'Orbitron'; font-size: 11px; box-sizing: border-box; outline: none; }
        .btn-ui { width: 100%; height: 48px; border: none; border-radius: 4px; font-family: 'Orbitron'; font-weight: 900; font-size: 12px; cursor: pointer; text-transform: uppercase; color: #fff !important; }
        .btn-red { background: var(--main-red); box-shadow: var(--neon); }
        .btn-gray { background: #1a1a1a; border: 1px solid #555; }
        #player { width: 100%; aspect-ratio: 16/9; border: 1px solid var(--border-color); background:#000; margin-bottom: 10px; }
        .playback-ctrl { margin-bottom: 10px; display: flex; gap: 10px; justify-content: center; background: #000; padding: 8px; border-radius: 30px; border: 1px solid var(--border-color); }
        .ctrl-icon { width: 40px; height: 40px; border-radius: 50%; background: #111; color: #fff; border: 1px solid #555; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #imageFileInput { display: none; }
        .file-label { width: 100%; height: 42px; background: #1a1a1a; border: 1px solid #555; color: #fff; font-family: 'Orbitron'; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        #reserve-list { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--main-red) #000; }
        .list-item { background: #0d0d0d; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; align-items: center; gap: 10px; border-left: 2px solid var(--main-red); }
        .list-item img { width: 65px; border-radius: 2px; }
        .status-msg { font-size: 9px; color: #fff; height: 12px; text-align: center; font-weight: bold; margin-top: 2px; }
    </style>
</head>
<body>
<div class="master-container">
    <div class="left">
        <div class="logo"><span>27</span> STAFF</div>
        <div class="input-group">
            <div class="section-label">REQUEST QUEUE</div>
            <input type="text" id="urlInput" placeholder="YOUTUBE URL...">
            <input type="text" id="nameInput" placeholder="REQUESTER...">
            <button class="btn-ui btn-red" onclick="addToQueue()">ADD TO QUEUE</button>
            <div id="submitStatus" class="status-msg"></div>
        </div>
        <div class="playback-ctrl">
            <button class="ctrl-icon" title="Restart" onclick="control('restart')">⏮</button>
            <button class="ctrl-icon" title="Play Top of Queue" onclick="playNextInQueue()">▶</button>
            <button class="ctrl-icon" title="Pause" onclick="control('pause')">⏸</button>
        </div>
        <div id="player"></div>
        <div class="input-group">
            <div class="section-label">GALLERY</div>
            <label for="imageFileInput" class="file-label" id="fileLabel">SELECT & POST IMAGE</label>
            <input type="file" id="imageFileInput" accept="image/*" onchange="autoUpload(this)">
            <div id="uploadStatus" class="status-msg"></div>
        </div>
    </div>
    <div class="right">
        <div class="section-label">RESERVATION QUEUE (DRAG TO REORDER)</div>
        <div id="reserve-list"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDoZtzHkOcC3p565fLN4oGO7vmlwQZiNkE",
        databaseURL: "https://club-d0011-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "club-d0011",
        appId: "1:51948793811:web:1edecab7c41c1d84ad8926"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let player, currentId = "", firstQueueKey = "", firstQueueId = "";

    const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', { events: { 'onStateChange': (e) => syncDB(e.data, player.getCurrentTime()) } });
        loadQueue();
    }

    // 予約に追加のみ実行
    function addToQueue() {
        const url = document.getElementById('urlInput').value;
        const name = document.getElementById('nameInput').value || "GUEST";
        const id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
        if (!id || id.length < 5) return;

        db.ref('queue').push({ videoId: id, requester: name, order: Date.now() });
        document.getElementById('submitStatus').innerText = "SUCCESSFULLY ADDED";
        document.getElementById('urlInput').value = ""; document.getElementById('nameInput').value = "";
        setTimeout(() => document.getElementById('submitStatus').innerText = "", 2000);
    }

    // 予約リストの1番目を再生する機能
    function playNextInQueue() {
        if (firstQueueId) {
            executeLive(firstQueueId);
            db.ref(`queue/${firstQueueKey}`).remove();
        } else if (player && currentId) {
            player.playVideo(); // リストが空なら今の曲を再開
        }
    }

    function loadQueue() {
        db.ref('queue').orderByChild('order').on('value', snap => {
            const list = document.getElementById('reserve-list');
            list.innerHTML = "";
            let count = 0;
            snap.forEach(c => {
                const item = c.val();
                if (count === 0) { firstQueueKey = c.key; firstQueueId = item.videoId; }
                const div = document.createElement('div');
                div.className = "list-item";
                div.innerHTML = `
                    <img src="https://img.youtube.com/vi/${item.videoId}/mqdefault.jpg">
                    <div style="flex-grow:1;">
                        <span style="font-size:8px; color:var(--main-red); display:block;">FROM: ${item.requester.toUpperCase()}</span>
                        <span style="font-size:10px; color:#fff;">${item.videoId}</span>
                    </div>
                    <button class="btn-ui btn-gray" style="width:60px; height:30px; font-size:8px;" onclick="playSelected('${c.key}','${item.videoId}')">PLAY</button>
                    <button class="btn-ui btn-gray" style="width:35px; height:30px; font-size:8px; color:#ff0033 !important; margin-left:3px;" onclick="db.ref('queue/${c.key}').remove()">✕</button>
                `;
                list.appendChild(div);
                count++;
            });
            if (count === 0) { firstQueueKey = ""; firstQueueId = ""; }
            Sortable.create(list, { 
                animation: 150,
                onEnd: function() {
                    // 並び替え後の順番をDBに保存する処理（任意）
                }
            });
        });
    }

    function playSelected(k, id) { executeLive(id); db.ref(`queue/${k}`).remove(); }
    function executeLive(id) { currentId = id; player.loadVideoById(id, 0); syncDB(1, 0); db.ref('backnumbers').push({ videoId: id, timestamp: firebase.database.ServerValue.TIMESTAMP }); }
    function syncDB(state, time) { if (!currentId) return; db.ref('sync').set({ videoId: currentId, state: state, time: time, lastUpdate: Date.now() }); }
    function control(cmd) { if (!player || !currentId) return; if (cmd === 'restart') player.seekTo(0); cmd === 'pause' ? player.pauseVideo() : player.playVideo(); setTimeout(() => syncDB(player.getPlayerState(), player.getCurrentTime()), 200); }
    
    function autoUpload(input) {
        const file = input.files[0]; if (!file) return;
        const status = document.getElementById('uploadStatus'); status.innerText = "UPLOADING...";
        const reader = new FileReader();
        reader.onload = (e) => {
            db.ref('gallery').push({ url: e.target.result, timestamp: firebase.database.ServerValue.TIMESTAMP }).then(() => {
                status.innerText = "POST SUCCESS"; input.value = ""; setTimeout(() => status.innerText = "", 2000);
            });
        };
        reader.readAsDataURL(file);
    }
    setInterval(() => { if (player && player.getPlayerState() === 1) syncDB(1, player.getCurrentTime()); }, 3000);
</script>
</body>
</html>
