<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ—ãƒ­ç®¡ç†ãƒ‘ãƒãƒ« (æ›²åï¼†ä¸¦ã¹æ›¿ãˆå¯¾å¿œ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --main-red: #ff4444; --bg: #0f0f0f; --panel: #1e1e1e; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; }
        .wrapper { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; height: 90vh; }
        .left-panel { flex: 1; background: var(--panel); padding: 25px; border-radius: 15px; border: 1px solid #333; }
        .right-panel { width: 450px; background: var(--panel); padding: 25px; border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; }
        h3 { border-left: 4px solid var(--main-red); padding-left: 10px; margin-top: 0; font-size: 16px; }
        .status-box { background: #000; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #current-time { font-family: monospace; font-size: 32px; color: var(--main-red); }
        input { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: white; box-sizing: border-box; margin-bottom: 10px; }
        .btn-main { background: var(--main-red); color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
        .btn-sub { background: #444; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 48%; margin-top:10px; }
        
        /* äºˆç´„ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #queue-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; border: 1px dashed #444; border-radius: 5px; }
        .queue-item { 
            background: #2a2a2a; padding: 12px; border-radius: 5px; margin: 5px; 
            font-size: 13px; display: flex; align-items: center; 
            cursor: grab; border-left: 4px solid #666; 
        }
        .queue-item:active { cursor: grabbing; }
        .queue-item .title-text { flex: 1; margin-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .remove-btn { color: #888; border: none; background: none; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="left-panel">
        <h3>CONTROLS</h3>
        <div class="status-box">
            <div id="current-title" style="font-size: 14px; color: #ffaaaa; margin-bottom: 5px;">åœæ­¢ä¸­</div>
            <div id="current-time">00:00</div>
        </div>
        <input type="text" id="nextUrl" placeholder="YouTube URLã‚’è²¼ã‚Šä»˜ã‘">
        <button class="btn-main" onclick="addToQueue()">äºˆç´„ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-sub" onclick="togglePause()">ä¸€æ™‚åœæ­¢/å†é–‹</button>
            <button class="btn-sub" onclick="stopVideo()">å®Œå…¨åœæ­¢</button>
        </div>
    </div>

    <div class="right-panel">
        <h3>RESERVE LIST (ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ)</h3>
        <ul id="queue-list"></ul>
        <button class="btn-main" style="margin-top: 15px; background: #28a745;" onclick="playNextFromQueue()">ãƒªã‚¹ãƒˆã®å…ˆé ­ã‚’å†ç”Ÿ ğŸš€</button>
    </div>
</div>

<script>
    // Firebaseè¨­å®šï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰
    const firebaseConfig = {
        apiKey: "AIzaSyDoZtzHkOcC3p565fLN4oGO7vmlwQZiNkE",
        databaseURL: "https://club-d0011-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "club-d0011",
        appId: "1:51948793811:web:1edecab7c41c1d84ad8926"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let queue = []; // {id: "xxx", title: "æ›²å"} ã®å½¢å¼ã§ä¿å­˜
    let playStartTime = 0;
    let timerInterval = null;
    let isPaused = false;

    // ä¸¦ã¹æ›¿ãˆæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    const el = document.getElementById('queue-list');
    Sortable.create(el, {
        animation: 150,
        onEnd: function() {
            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«é…åˆ—ã®é †ç•ªã‚’æ›´æ–°
            const items = el.querySelectorAll('.queue-item');
            const newQueue = [];
            items.forEach(item => {
                newQueue.push({
                    id: item.dataset.id,
                    title: item.dataset.title
                });
            });
            queue = newQueue;
        }
    });

    function getID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : url;
    }

    // æ›²åã‚’å–å¾—ã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ 
    async function addToQueue() {
        const url = document.getElementById('nextUrl').value;
        const id = getID(url);
        if (!id) return;

        document.getElementById('nextUrl').value = "å–å¾—ä¸­...";
        
        try {
            // YouTubeã®åŸ‹ã‚è¾¼ã¿ç”¨oEmbed APIã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
            const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
            const data = await response.json();
            queue.push({ id: id, title: data.title });
        } catch (e) {
            queue.push({ id: id, title: "ä¸æ˜ãªã‚¿ã‚¤ãƒˆãƒ«" });
        }

        renderQueue();
        document.getElementById('nextUrl').value = "";
    }

    function renderQueue() {
        const list = document.getElementById('queue-list');
        list.innerHTML = queue.map((item, index) => `
            <li class="queue-item" data-id="${item.id}" data-title="${item.title}">
                <div class="title-text"><strong>${index + 1}.</strong> ${item.title}</div>
                <button class="remove-btn" onclick="removeAt(${index})">Ã—</button>
            </li>
        `).join('');
    }

    function removeAt(index) {
        queue.splice(index, 1);
        renderQueue();
    }

    function playNextFromQueue() {
        if (queue.length === 0) return;
        const track = queue.shift();
        renderQueue();
        
        playStartTime = Date.now();
        db.ref('sync').set({
            videoId: track.id,
            state: 1,
            serverStartTime: firebase.database.ServerValue.TIMESTAMP,
            baseTime: 0
        });

        // å±¥æ­´ä¿å­˜ï¼ˆãƒãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ï¼‰
        db.ref('backnumbers').push({
            title: track.title, // æ›²åã§ä¿å­˜
            videoId: track.id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        document.getElementById('current-title').innerText = "å†ç”Ÿä¸­: " + track.title;
        startTimer();
    }

    function stopVideo() {
        db.ref('sync').update({ state: 0, videoId: "" });
        clearInterval(timerInterval);
        document.getElementById('current-time').innerText = "00:00";
        document.getElementById('current-title').innerText = "åœæ­¢ä¸­";
    }

    function togglePause() {
        isPaused = !isPaused;
        db.ref('sync').update({ state: isPaused ? 2 : 1 });
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (isPaused) return;
            const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            document.getElementById('current-time').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }, 1000);
    }
</script>
</body>
</html>
