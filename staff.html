<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>27 Club - Staff System</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Orbitron', sans-serif; background: #000; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .left { width: 40%; padding: 40px; border-right: 1px solid #222; background: linear-gradient(to bottom, #111, #000); }
        .right { width: 60%; padding: 40px; background: #050505; overflow-y: auto; }
        h1 { font-weight: 900; letter-spacing: 5px; border-bottom: 2px solid #ff0033; padding-bottom: 10px; margin-top: 0; }
        h1 span { color: #ff0033; }
        input { width: 100%; padding: 15px; background: #111; border: 1px solid #333; color: white; font-family: sans-serif; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        button.main { width: 100%; padding: 20px; background: #ff0033; color: white; border: none; border-radius: 5px; font-family: 'Orbitron', sans-serif; font-weight: 900; cursor: pointer; transition: 0.3s; }
        button.main:hover { background: #ff4466; box-shadow: 0 0 20px #ff0033; }
        #player { width: 100%; aspect-ratio: 16/9; margin-top: 30px; border: 1px solid #222; border-radius: 5px; background: #000; }
        .history-item { background: #111; padding: 15px; margin-bottom: 12px; border-radius: 8px; display: flex; align-items: center; gap: 20px; border-left: 5px solid #333; }
        .history-item img { width: 100px; border-radius: 4px; }
        .history-info { flex-grow: 1; font-size: 12px; }
        .btn-del { padding: 5px 10px; background: #300; color: #f66; border: 1px solid #500; cursor: pointer; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="left">
        <h1><span>27</span> CLUB</h1>
        <div id="status" style="color:#0f0; font-size:12px; margin-bottom:10px;">Ready</div>
        <input type="text" id="urlInput" placeholder="ENTER YOUTUBE URL...">
        <button class="main" onclick="broadcast()">PUSH TO LIVE</button>
        <div id="player"></div>
    </div>
    <div class="right">
        <h2 style="font-size: 14px; letter-spacing: 3px; color: #555; margin-top:0;">DATABASE ARCHIVE</h2>
        <div id="history-list"></div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDoZtzHkOcC3p565fLN4oGO7vmlwQZiNkE",
        databaseURL: "https://club-d0011-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "club-d0011",
        appId: "1:51948793811:web:1edecab7c41c1d84ad8926"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let player;

    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', { events: { 'onStateChange': (e) => sync(e.data) } });
        loadHistory();
    }

    async function broadcast() {
        const url = document.getElementById('urlInput').value;
        const id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
        if (!id) return;

        player.loadVideoById(id, 0);
        db.ref('sync').set({ videoId: id, state: 1, time: 0, lastUpdate: Date.now() });

        const snap = await db.ref('backnumbers').once('value');
        snap.forEach(c => { if(c.val().videoId === id) db.ref(`backnumbers/${c.key}`).remove(); });
        
        db.ref('backnumbers').push({
            title: new Date().toLocaleString() + " 配信",
            videoId: id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        document.getElementById('status').innerText = "LIVE NOW";
        document.getElementById('urlInput').value = "";
    }

    function loadHistory() {
        db.ref('backnumbers').orderByChild('timestamp').on('value', snap => {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            let items = [];
            snap.forEach(c => items.push({key:c.key, ...c.val()}));
            items.reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = "history-item";
                div.innerHTML = `<img src="https://img.youtube.com/vi/${item.videoId}/mqdefault.jpg"><div class="history-info">${item.title}</div><button class="btn-del" onclick="deleteItem('${item.key}')">DEL</button>`;
                list.appendChild(div);
            });
        });
    }

    function deleteItem(k) { if(confirm("Delete?")) db.ref(`backnumbers/${k}`).remove(); }

    function sync(s) {
        db.ref('sync').update({ state: s, time: player.getCurrentTime(), lastUpdate: Date.now() });
    }

    setInterval(() => { if(player && player.getPlayerState() === 1) sync(1); }, 1000);
</script>
</body>
</html>
