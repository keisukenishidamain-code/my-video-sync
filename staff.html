<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ—ãƒ­ç®¡ç†ãƒ‘ãƒãƒ«</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --main-red: #ff4444; --bg: #0f0f0f; --panel: #1e1e1e; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; overflow: hidden; }
        
        /* å·¦å³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .wrapper { display: flex; gap: 20px; height: 90vh; max-width: 1200px; margin: 0 auto; }
        
        /* å·¦å´ï¼šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .left-panel { flex: 1; background: var(--panel); padding: 25px; border-radius: 15px; border: 1px solid #333; }
        
        /* å³å´ï¼šäºˆç´„ãƒªã‚¹ãƒˆ */
        .right-panel { width: 350px; background: var(--panel); padding: 25px; border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; }
        
        h3 { border-left: 4px solid var(--main-red); padding-left: 10px; margin-top: 0; margin-bottom: 20px; font-size: 16px; }

        .status-box { background: #000; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #current-time { font-family: monospace; font-size: 32px; color: var(--main-red); }

        input { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #444; background: #2a2a2a; color: white; box-sizing: border-box; margin-bottom: 10px; }
        
        .btn-main { background: var(--main-red); color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-bottom: 10px; }
        .btn-sub { background: #444; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 48%; }
        .btn-row { display: flex; justify-content: space-between; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        #queue-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .queue-item { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 8px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #666; }
        .queue-item:hover { border-left-color: var(--main-red); }
        .remove-btn { color: #888; cursor: pointer; border: none; background: none; font-size: 18px; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="left-panel">
        <h3>CONTROLS</h3>
        <div class="status-box">
            <div style="font-size: 12px; color: #888; margin-bottom: 5px;">CURRENT PLAYBACK</div>
            <div id="current-title" style="font-size: 14px; margin-bottom: 5px;">åœæ­¢ä¸­</div>
            <div id="current-time">00:00</div>
        </div>

        <input type="text" id="nextUrl" placeholder="YouTube URLã‚’è²¼ã‚Šä»˜ã‘">
        <button class="btn-main" onclick="addToQueue()">äºˆç´„ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        
        <div class="btn-row">
            <button class="btn-sub" onclick="togglePause()">ä¸€æ™‚åœæ­¢/å†é–‹</button>
            <button class="btn-sub" onclick="stopVideo()">å®Œå…¨åœæ­¢</button>
        </div>
        <p id="log" style="font-size: 12px; color: #666; margin-top: 15px;"></p>
    </div>

    <div class="right-panel">
        <h3>RESERVE LIST (QUEUE)</h3>
        <ul id="queue-list"></ul>
        <button class="btn-main" style="margin-top: 15px; background: #28a745;" onclick="playNextFromQueue()">ãƒªã‚¹ãƒˆã®æ›²ã‚’é–‹å§‹ ğŸš€</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDoZtzHkOcC3p565fLN4oGO7vmlwQZiNkE",
        databaseURL: "https://club-d0011-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "club-d0011",
        appId: "1:51948793811:web:1edecab7c41c1d84ad8926"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let queue = [];
    let playStartTime = 0;
    let timerInterval = null;
    let isPaused = false;

    function getID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : url;
    }

    // 1. äºˆç´„ãƒªã‚¹ãƒˆã«è¿½åŠ 
    function addToQueue() {
        const url = document.getElementById('nextUrl').value;
        const id = getID(url);
        if (id) {
            queue.push(id);
            renderQueue();
            document.getElementById('nextUrl').value = "";
            document.getElementById('log').innerText = "ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ";
        }
    }

    // 2. ãƒªã‚¹ãƒˆã‹ã‚‰å†ç”Ÿï¼ˆå¿…ãš0ç§’ã‹ã‚‰ï¼‰
    function playNextFromQueue() {
        if (queue.length === 0) {
            alert("äºˆç´„ãƒªã‚¹ãƒˆãŒç©ºã§ã™");
            return;
        }
        const id = queue.shift(); // å…ˆé ­ã®æ›²ã‚’å–ã‚Šå‡ºã™
        renderQueue();
        
        // ã€é‡è¦ã€‘0ç§’ã‹ã‚‰å†ç”Ÿã™ã‚‹ãŸã‚ã®è¨­å®š
        playStartTime = Date.now();
        db.ref('sync').set({
            videoId: id,
            state: 1,
            serverStartTime: firebase.database.ServerValue.TIMESTAMP, // ã“ã‚ŒãŒ0ç§’ã®åŸºæº–
            baseTime: 0 // å¼·åˆ¶çš„ã«0ç§’ã‚¹ã‚¿ãƒ¼ãƒˆ
        });

        // å±¥æ­´ä¿å­˜
        const now = new Date();
        db.ref('backnumbers').push({
            title: `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')} é…ä¿¡é–‹å§‹`,
            videoId: id,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        document.getElementById('current-title').innerText = id;
        startTimer();
    }

    function renderQueue() {
        const list = document.getElementById('queue-list');
        list.innerHTML = queue.map((id, index) => `
            <li class="queue-item">
                <span>${index + 1}. ID: ${id}</span>
                <button class="remove-btn" onclick="removeAt(${index})">Ã—</button>
            </li>
        `).join('');
    }

    function removeAt(index) {
        queue.splice(index, 1);
        renderQueue();
    }

    function stopVideo() {
        db.ref('sync').update({ state: 0, videoId: "" });
        clearInterval(timerInterval);
        document.getElementById('current-title').innerText = "åœæ­¢ä¸­";
        document.getElementById('current-time').innerText = "00:00";
    }

    function togglePause() {
        isPaused = !isPaused;
        db.ref('sync').update({ state: isPaused ? 2 : 1 });
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (isPaused) return;
            const elapsed = Math.floor((Date.now() - playStartTime) / 1000);
            const m = Math.floor(elapsed / 60);
            const s = elapsed % 60;
            document.getElementById('current-time').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }, 1000);
    }
</script>
</body>
</html>
